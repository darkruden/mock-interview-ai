name: Quality Assurance

# Dispara o workflow apenas quando há mudanças relevantes
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'               # Só roda se mexer no backend
      - '.github/workflows/**'     # Ou na configuração do CI
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'

jobs:
  backend-tests:
    name: Run Backend Tests (Unit & Integration)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend  # Define a pasta raiz para os comandos

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'  # Habilita cache automático do pip para ser mais rápido

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Instala dependências de teste se o arquivo existir
        if [ -f requirements-test.txt ]; then pip install -r requirements-test.txt; fi

    - name: Run Automated Tests
      # Define variáveis de ambiente FAKE explicitamente para segurança duplicada
      env:
        AWS_ACCESS_KEY_ID: testing
        AWS_SECRET_ACCESS_KEY: testing
        AWS_SECURITY_TOKEN: testing
        AWS_SESSION_TOKEN: testing
        AWS_DEFAULT_REGION: us-east-1
        BUCKET_NAME: mock-interview-tests-bucket
        TABLE_NAME: MockInterviewSessions-Test
        GEMINI_API_KEY: fake_key
      run: |
        # O comando --ignore=tests/scripts garante que o CI pule os testes manuais
        # --cov=src gera relatório de cobertura apenas do código fonte real
        pytest -v tests/unit tests/integration --ignore=tests/scripts --cov=src --cov-fail-under=80